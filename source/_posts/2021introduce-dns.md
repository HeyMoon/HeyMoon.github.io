---
title: Introduce DNS
date: 2021-11-02 22:22:01
tags:
    - DNS
categories:
    - tech
---

### 什么是 DNS?
生活中，人们通过例如 google.com 等域名来访问信息。但是 Web 浏览器是通过 IP 地址进行交互的。DNS(Domain Name System) 是一个将域名和IP地址相互映射的分布式数据库，能够使人更方便地访问互联网。DNS使用TCP和UDP端口 53。

<!--more-->

### 历史
DNS 起源于互联网的早期，当时互联网是美国国防部为研究目的建立的一个小网络。该网络中计算机的主机名是通过使用位于集中管理的服务器上的单个HOSTS文件进行管理的。需要解决网络主机名的每个站点都下载了此文件。随着互联网上主机数量的增加，更新过程产生的流量以及HOSTS文件的大小也增加了。对新系统的需求变得越来越明显，该系统将提供可伸缩性、分散管理、支持各种数据类型等功能。

1984年引入的 DNS 成为这个新系统。使用 DNS，主机名存在一个数据库中，该数据库可以分布在多台服务器之间，减少了任何一台服务器的负载，并提供了按分区管理此命名系统的能力。DNS支持分层名称，除了HOSTS文件中使用的主机名称到IP地址映射外，还允许注册各种数据类型。由于DNS数据库是分布式的，因此当添加更多服务器时，其潜在大小是无限的，性能不会下降。

最初的 DNS 基于 Request for Comment (RFC) 882 (Domain Names: Concepts and Facilities) 和 RFC 883 (Domain Names–Implementation and Specification)，随后被 RFC 1034 (Domain Names–Concepts and Facilities), and RFC 1035 (Domain Names–Implementation and Specification) 所取代。

DNS的实现——Berkeley Internet Name Domain（BIND）——最初是为4.3 BSD UNIX操作系统开发的。大多数 DNS 实现都基于 RFC 1034 和 RFC 1035。

早期的域名必须以英文句号 . 结尾。例如，当用户访问HTTP服务时必须在地址栏中输入：`http://www.wikipedia.org.`，这样DNS才能够进行域名解析。如今DNS服务器已经可以自动补上结尾的句号。

### DNS domain namespace
域名系统作为一个分层和分布式数据库实现，包含各种类型的数据，包括主机名和域名。DNS数据库中的名称形成一个名为域名空间的分层树结构。域名由用点分隔的单个标签组成，例如：mydomain.microsoft.com。这个域名有三个标签，分别是 mydomain, microsoft, com。

完全限定域名（FQDN,fully qualify domain name）通过指定从引用主机到根的路径中用点分隔的名称列表，唯一标识主机在DNS层次树中的位置。下图显示了Microsoft.com.域中具有名为mydomain的主机的DNS树示例。主机的FQDN将是 mydomain.microsoft.com。

![dns-name-spaces](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/images/dd197427.b806a082-8b59-44cd-87cc-eaaffceef548(ws.10).gif)

从技术上讲，树中使用的任何DNS域名都是一个域名。然而，大多数DNS讨论都根据名称的级别和常用方式，以五种方式之一识别名称。例如，注册到微软（microsoft.com.）的DNS域名被称为二级域名。这是因为名称有两个部分（称为标签），表明它位于树根或树顶部下方的两个级别。大多数DNS域名有两个或多个标签，每个标签都表示树中的新级别。句点用于名称来分隔标签。

下表描述了用于通过名称空间中的函数描述DNS域名的五个类别，以及每种名称类型的示例。

#### DNS 域名类型

| 名称类型    | 描述     |      示例       |
| :------------- | :------------- | :---------- |
| root 域(根域)       | 这是树的顶部，表示一个未命名的级别；它有时显示为两个空引号（“”），表示空值。在DNS域名中使用时，它由尾随句点（.）声明，以指定名称位于域层次结构的根或最高层。在这种情况下，DNS域名被视为完整，并指向名称树中的确切位置。以这种方式声明的名称是FQDN。       |    单个句点（.）或名称末尾使用的句号，如“example.microsoft.com.”。         |
| 顶级域名       | 用于指示使用名称的国家/区域或组织类型的名称。       |    “.com”，表示在互联网上注册用于商业用途的企业的名称。         |
| 二级域名       | 向个人或组织注册以便在互联网上使用的可变长度名称。这些名称始终基于适当的顶级域，具体取决于使用名称的组织类型或地理位置。       |   “microsoft.com.”是互联网DNS域名注册商在微软注册的二级域名。          |
| 子域       | 组织可以创建的从注册的二级域名派生的其他名称。这些包括添加名称，以在组织中增加DNS名称树，并将其划分为部门或地理位置       |  “example.microsoft.com.”，这是微软分配给文档示例名称的虚拟子域。           |
| 主机或资源名称       | 在DNS名称树中表示叶子并识别特定资源的名称。通常，DNS域名的最左边标签标识网络上的特定计算机。例如，如果主机（A）资源记录中使用了此级别的名称，则该名称用于根据主机名称查找计算机的IP地址。       |     “host-a.example.microsoft.com.”，其中第一个标签（“host-a”）是网络上特定计算机的DNS主机名。        |

#### DNS和互联网域
互联网域名系统由互联网上的域名注册机构管理，负责维护按组织和国家/地区分配的顶级域名。这些域名遵循国际标准3166。下表显示了许多保留给各组织使用的现有缩写，以及用于国家/地区的两字母和三字母缩写：

一些DNS顶级域名（TLD）

| DNS域名     |  组织类型     |
| :------------- | :------------- |
| com       | 商业组织       |
| edu       | 教育机构       |
| org       | 非营利组织       |
| net       | 网络       |
| gov       | 非军事政府组织       |
| mil       | 军政府组织       |
| arpa       | 反向DNS       |
| “xx”      | 双字母国家代码（例如，cn,us,au,ca,fr）       |

#### Resource Record
DNS数据库由资源记录（RR）组成。每个RR都标识数据库中的特定资源。DNS中有各种类型的RR。常见的 DNS RR 记录类型如下：

+ A：地址记录（A 即 Address 的首字母），返回域名指向的IP地址。
+ NS：域名服务器记录（Name Server），返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为IP地址。
+ MX：邮件记录（Mail eXchange），返回接收电子邮件的服务器地址。
+ CNAME：规范名称记录（Canonical Name），返回另一个域名，即当前查询的域名是另一个域名的跳转
+ PTR：逆向查询记录（Pointer Record），只用于从IP地址查询域名

### DNS 查询
通常，DNS 查找信息将本地缓存在查询计算机内，或者远程缓存在 DNS 基础设施内。DNS 查找通常有 8 个步骤。缓存 DNS 信息时，将从 DNS 查找过程中跳过一些步骤，从而使该过程更快。以下示例概述了不缓存任何内容时的所有 8 个步骤。

1. 用户在 Web 浏览器中键入 “example.com”，查询传输到 Internet 中，并被 DNS 递归解析器接收。
2. 接着，解析器查询 DNS 根域名服务器（.）。
3. 然后，根服务器使用存储其域信息的顶级域（TLD）DNS 服务器（例如 .com 或 .net）的地址响应该解析器。在搜索 example.com 时，我们的请求指向 .com TLD。
4. 然后，解析器向 .com TLD 发出请求。
5. TLD 服务器随后使用该域的域名服务器 example.com 的 IP 地址进行响应。
6. 最后，递归解析器将查询发送到域的域名服务器。
7. example.com 的 IP 地址而后从域名服务器返回解析器。
8. 然后 DNS 解析器使用最初请求的域的 IP 地址响应 Web 浏览器。

DNS 查找的这 8 个步骤返回 example.com 的 IP 地址后，浏览器便能发出对该网页的请求：

9. 浏览器向该 IP 地址发出 HTTP 请求。
10. 位于该 IP 的服务器返回将在浏览器中呈现的网页（第 10 步）。

![dns-lookup](https://www.cloudflare.com/img/learning/dns/what-is-dns/dns-lookup-diagram.png)

### DNS 查询有哪些类型？

典型 DNS 查找中会出现三种类型的查询。通过组合使用这些查询，优化的 DNS 解析过程可缩短传输距离。在理想情况下，可以使用缓存的记录数据，从而使 DNS 域名服务器能够返回非递归查询。

3 种 DNS 查询类型：

递归查询 - 在递归查询中，DNS 客户端要求 DNS 服务器（一般为 DNS 递归解析器）将使用所请求的资源记录响应客户端，或者如果解析器无法找到该记录，则返回错误消息。

迭代查询 - 在这种情况下，DNS 客户端将允许 DNS 服务器返回其能够给出的最佳应答。如果所查询的 DNS 服务器与查询名称不匹配，则其将返回对较低级别域名空间具有权威性的 DNS 服务器的引用。然后，DNS 客户端将对引用地址进行查询。此过程继续使用查询链中的其他 DNS 服务器，直至发生错误或超时为止。

非递归查询 - 当 DNS 解析器客户端查询 DNS 服务器以获取其有权访问的记录时通常会进行此查询，因为其对该记录具有权威性，或者该记录存在于其缓存内。DNS 服务器通常会缓存 DNS 记录，以防止更多带宽消耗和上游服务器上的负载。

### 什么是 DNS 高速缓存？DNS 高速缓存发生在哪里？

缓存的目的是将数据临时存储在某个位置，从而提高数据请求的性能和可靠性。DNS 高速缓存涉及将数据存储在更靠近请求客户端的位置，以便能够更早地解析 DNS 查询，并且能够避免在 DNS 查找链中进一步向下的额外查询，从而缩短加载时间并减少带宽/CPU 消耗。DNS 数据可缓存到各种不同的位置上，每个位置均将存储 DNS 记录并保存由生存时间（TTL）决定的一段时间。

浏览器 DNS 缓存

现代 Web 浏览器设计为默认将 DNS 记录缓存一段时间。目的很明显；越靠近 Web 浏览器进行 DNS 缓存，为检查缓存并向 IP 地址发出正确请求而必须采取的处理步骤就越少。发出对 DNS 记录的请求时，浏览器缓存是针对所请求的记录而检查的第一个位置。

在 Chrome 浏览器中，您可以转到 chrome://net-internals/#dns 查看 DNS 缓存的状态。

操作系统（OS）级 DNS 缓存

操作系统级 DNS 解析器是 DNS 查询离开您计算机前的第二站，也是本地最后一站。操作系统内旨在处理此查询的过程通常称为“存根解析器”或 DNS 客户端。当存根解析器获取来自某个应用程序的请求时，其首先检查自己的缓存，以便查看是否有此记录。如果没有，则将本地网络外部的 DNS 查询（设置了递归标记）发送到 Internet 服务提供商（ISP）内部的 DNS 递归解析器。

与先前所有步骤一样，当 ISP 内的递归解析器收到 DNS 查询时，其还将查看所请求的主机到 IP 地址转换是否已经存储在其本地持久性层中。

根据其缓存中具有的记录类型，递归解析器还具有其他功能：

1. 如果解析器没有 A 记录，但确实有针对权威性域名服务器的 NS 记录，则其将直接查询这些域名服务器，从而绕过 DNS 查询中的几个步骤。此快捷方式可防止从根和 .com 域名服务器（在我们对 example.com 的搜索中）进行查找，并且有助于更快地解析 DNS 查询。

2. 如果解析器没有 NS 记录，它会向 TLD 服务器（本例中为 .com）发送查询，从而跳过根服务器。

3. 万一解析器没有指向 TLD 服务器的记录，其将查询根服务器。这种情况通常在清除了 DNS 高速缓存后发生。

### DNS Load Balancing
DNS负载平衡取决于大多数客户端使用他们收到的域名的第一个IP地址这一事实。在大多数Linux发行版中，默认情况下，DNS每次响应新客户端时都会使用 Round robin 方式以不同的顺序发送IP地址列表。因此，不同的客户端将请求定向到不同的服务器，有效地在整个服务器组中分配负载。

不幸的是，DNS负载平衡的简单实现存在固有的问题，限制了其可靠性和效率。最重要的是，DNS不会检查服务器或网络中断或错误，因此即使服务器停机或无法访问，DNS也始终为域返回相同的IP地址集。

#### Round-robin
````
www IN A 64.131.79.131
www IN A 64.131.79.132
www IN A 64.131.79.133
www IN A 64.131.79.134
````

#### Weighted Round robin
加权 Round robin 提供了一种在可用资源之间公平分配负载的方式。在加权 Round robin 算法中，每个目标（此处为服务器）分配了一个值，该值与池中的其他服务器相比，该值表示该服务器的性能。与池中的其他服务器相比，此“权重”决定了该服务器以多（或更少）的请求发送了多少请求。

假设您有三台服务器经过单独基准测试和配置，这些服务器将部署在加权 Round robin 环境中。The
第一可以处理100个要求/秒，第二个可以处理300个要求/秒，最后一个只能处理25个要求/秒（平均而言，使用自动基准服务进行测试）
相同的数据）。通常，由于服务器性能存在如此差异，第三个将完全排除在设置之外。但在加权循环中，每台服务器都可以在循环配置脚本/文件中尽可能多地分配：

资源权重
——————
server1.fqdn 4
server2.fqdn 12
server3.fqdn 1

很明显，接下来会发生什么：每12个请求将发送到服务器2，4个将发送到服务器1个，只有1个将发送到服务器3。结果是负载分布更加均匀，即使不那么相等。

用途：
1. prevent traffic from going to servers under maintenance
2. balance between varying cluster sizes
3. A/B testing

#### Latency-based
加权 Round robin 考虑了服务器的资源与负载来分配请求，但是没有考虑网络。



#### Geolocation-based
基于地理位置





参考:

[what is dns](https://www.cloudflare.com/zh-cn/learning/dns/what-is-dns/)

[dns](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd197427(v=ws.10)?redirectedfrom=MSDN)

[dns balancing](https://www.nginx.com/resources/glossary/dns-load-balancing/)
